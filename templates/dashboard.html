<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusOS</title>
    
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#10b981">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            /* MINT LEAF PALETTE */
            --bg-body: #f0fdf4; --bg-sidebar: #ffffff; --card-bg: #ffffff; --border-color: #d1fae5;
            --primary-color: #10b981; --primary-hover: #059669; --primary-light: #d1fae5;
            --text-main: #111827; --text-muted: #6b7280;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.025);
            --sidebar-width: 260px;
        }

        body { 
            background-color: var(--bg-body); 
            font-family: 'Inter', sans-serif; 
            color: var(--text-main); 
            letter-spacing: normal !important; /* Force remove spacing */
        }
        
        h1, h2, h3, h4, h5, h6 { 
            font-family: 'Outfit', sans-serif; 
            color: #0f172a; 
            font-weight: 600; /* Reduced from bold */
            letter-spacing: normal;
        }

        /* SIDEBAR */
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); padding: 30px 25px; display: flex; flex-direction: column; z-index: 1000; box-shadow: var(--shadow-sm); }
        .brand { font-size: 1.4rem; font-weight: 600; color: var(--primary-color); margin-bottom: 3rem; display: flex; align-items: center; gap: 12px; }
        .nav-link { display: flex; align-items: center; gap: 14px; padding: 12px 18px; color: var(--text-muted); font-weight: 400; /* Lighter text */ border-radius: 12px; transition: 0.2s; margin-bottom: 5px; }
        .nav-link:hover, .nav-link.active { background-color: var(--primary-light); color: var(--primary-hover); font-weight: 500; }
        .nav-link i { font-size: 1.2rem; }

        /* CONTENT */
        .main-content { margin-left: var(--sidebar-width); padding: 40px 50px 100px 50px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        
        /* SEARCH */
        .search-box { background: white; border: 1px solid var(--border-color); padding: 10px 20px; border-radius: 100px; display: flex; align-items: center; width: 380px; gap: 12px; color: var(--text-muted); box-shadow: var(--shadow-sm); }
        .search-box input { border: none; outline: none; width: 100%; color: var(--text-main); font-weight: 400; }

        /* CARDS */
        .dashboard-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 24px; padding: 28px; height: 100%; box-shadow: var(--shadow-md); transition: transform 0.2s ease; }
        .dashboard-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
        .widget-icon { width: 48px; height: 48px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; background: var(--primary-light); color: var(--primary-color); }
        
        /* COACH WIDGET */
        .coach-card { background: linear-gradient(to right, #fffbeb, #ffffff); border: 1px solid #fbbf24; border-left: 5px solid #f59e0b; border-radius: 16px; padding: 24px; margin-bottom: 30px; box-shadow: var(--shadow-md); transition: transform 0.2s; }
        .coach-card:hover { transform: translateY(-2px); }
        
        /* UTILS */
        .btn-primary { background: var(--primary-color); border: none; padding: 10px 24px; border-radius: 14px; font-weight: 500; /* Lighter button text */ color: white; transition: 0.2s; box-shadow: var(--shadow-sm); }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); }
        .btn-outline-secondary { border: 1px solid var(--border-color); background: white; color: var(--text-muted); padding: 8px 16px; border-radius: 10px; font-weight: 400; }
        .btn-outline-secondary:hover { background: #f8fafc; }
        
        /* Overrides for Bootstrap Weights */
        .fw-bold { font-weight: 600 !important; } /* Downgrade bold to semi-bold globally */
        .text-muted { font-weight: 400 !important; }
        
        /* Progress & Modals */
        .progress-slim { height: 6px; border-radius: 10px; background: #e2e8f0; margin-top: 5px; }
        .syllabus-mini { height: 4px; border-radius: 2px; background: #e2e8f0; width: 100%; display: block; margin-top: 6px; overflow: hidden; }
        .modal-content { border: 0; border-radius: 24px; box-shadow: var(--shadow-lg); }
        .form-control { background-color: #f8fafc; border: 1px solid var(--border-color); padding: 12px; border-radius: 12px; font-weight: 400; }
        
        /* Colors */
        .color-option { width: 32px; height: 32px; border-radius: 50%; display: inline-block; margin-right: 8px; cursor: pointer; border: 2px solid transparent; }
        .bg-emerald { background-color: #10b981; } .bg-blue { background-color: #3b82f6; } .bg-purple { background-color: #8b5cf6; } .bg-amber { background-color: #f59e0b; } .bg-rose { background-color: #f43f5e; } .bg-slate { background-color: #64748b; }
        .task-strip { width: 5px; height: 100%; position: absolute; left: 0; top: 0; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand"><i class="bi bi-mortarboard-fill"></i> CampusOS</div>
    <nav class="nav flex-column">
        <a href="/" class="nav-link active"><i class="bi bi-grid-fill"></i> Dashboard</a>
        <a href="/career" class="nav-link"><i class="bi bi-briefcase-fill"></i> Career Vault</a>
        <a href="/timetable" class="nav-link"><i class="bi bi-table"></i> Timetable</a>
        <a href="/calendar" class="nav-link"><i class="bi bi-calendar-event"></i> Calendar</a>
        <a href="/matrix" class="nav-link"><i class="bi bi-layers-fill"></i> Priority Matrix</a>
    </nav>
    <div class="mt-auto">
        <div class="nav-link" style="background: #f8fafc; border: 1px solid var(--border-color); cursor: default;">
            <div class="d-flex align-items-center gap-3">
                <div class="bg-white rounded-circle d-flex align-items-center justify-content-center border" style="width: 40px; height: 40px; color: var(--text-muted);"><i class="bi bi-person-fill"></i></div>
                <div style="line-height: 1.3;"><div class="fw-semibold text-dark" style="font-size: 0.9rem;">{{ settings.student_name }}</div><div class="text-muted" style="font-size: 0.75rem;">{{ settings.university }}</div></div>
            </div>
        </div>
        <button class="btn btn-outline-secondary w-100 btn-sm mt-3 border-0 bg-transparent text-start ps-0" data-bs-toggle="modal" data-bs-target="#profileModal"><i class="bi bi-gear me-2"></i> Settings</button>
    </div>
</div>

<div class="main-content">
    <div class="top-bar">
        <div><h2 class="fw-semibold mb-1">Hi, {{ settings.student_name.split(' ')[0] }}! üëã</h2><p class="text-muted mb-0 small">"{{ quote }}"</p></div>
        <div class="d-flex gap-3">
            <form action="/search" method="GET"><div class="search-box"><i class="bi bi-search"></i><input type="text" name="q" placeholder="Search tasks, notes..."></div></form>
            <button class="btn btn-primary rounded-circle shadow-lg d-flex align-items-center justify-content-center p-0" data-bs-toggle="modal" data-bs-target="#subjectModal" style="width: 52px; height: 52px;"><i class="bi bi-plus-lg fs-4"></i></button>
        </div>
    </div>

    {% if bottlenecks %}
        <div class="alert border-0 d-flex align-items-center gap-3 mb-4 shadow-sm" style="background: #fff7ed; color: #c2410c; border-left: 5px solid #f97316;">
            <i class="bi bi-fire fs-4"></i>
            <div><strong>High Pressure Alert:</strong> Multiple deadlines detected on {% for b in bottlenecks %}{{ b.date.strftime('%b %d') }} ({{ b.count }}){% if not loop.last %}, {% endif %}{% endfor %}</div>
        </div>
    {% endif %}

    {% if gaps %}
        <div class="alert border-0 d-flex align-items-center gap-3 mb-4 shadow-sm" style="background: #ecfdf5; color: #065f46; border-left: 5px solid #10b981;">
            <i class="bi bi-hourglass-split fs-4"></i>
            <div><strong>Gap Found:</strong> You have a free slot from <strong>{{ gaps[0].start }}:00</strong> to <strong>{{ gaps[0].end }}:00</strong> today!</div>
        </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-card d-flex align-items-center justify-content-between py-4">
                <div class="d-flex align-items-center gap-4">
                    <div class="widget-icon" style="width: 56px; height: 56px; font-size: 1.8rem;"><i class="bi bi-airplane-fill"></i></div>
                    <div><h5 class="fw-semibold mb-1">Attendance Forecaster</h5><span class="text-muted small">Simulate skipping classes safely.</span></div>
                </div>
                <form action="/forecast" method="POST" class="d-flex gap-2">
                    <input type="date" name="start_date" class="form-control" required>
                    <input type="date" name="end_date" class="form-control" required>
                    <button type="submit" class="btn btn-primary">Check Impact</button>
                </form>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            
            <div class="coach-card d-flex align-items-start gap-3">
                <div class="coach-icon"><i class="bi bi-lightbulb-fill"></i></div>
                <div>
                    <h5 class="fw-semibold mb-1 text-dark">Smart Efficiency Insight</h5>
                    <p class="mb-0 text-muted small" style="line-height: 1.6;">
                        {% if gaps %}
                            üöÄ <strong>Gap Strategy:</strong> You have a {{ gaps[0].end - gaps[0].start }}h break at {{ gaps[0].start }}:00. Perfect time to finish short 'Delegate' tasks.
                        {% elif bottlenecks %}
                            üõ°Ô∏è <strong>Burnout Defense:</strong> Heavy workload on {{ bottlenecks[0].date.strftime('%a') }}. Use the <i>Pomodoro Technique</i> (25m work, 5m break) to stay focused.
                        {% else %}
                            üìÖ <strong>Plan Ahead:</strong> Your schedule is light today. Use this time to update your <b>Career Vault</b> or learn a new skill.
                        {% endif %}
                    </p>
                </div>
            </div>

            <div class="dashboard-card p-0 overflow-hidden">
                <div class="p-4 border-bottom d-flex justify-content-between align-items-center bg-light bg-opacity-30">
                    <h5 class="fw-semibold mb-0">üìö My Courses</h5>
                    <button class="btn btn-sm btn-outline-secondary bg-white" data-bs-toggle="modal" data-bs-target="#subjectModal">Add New</button>
                </div>
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead><tr><th class="ps-5 text-muted fw-normal">COURSE</th><th class="text-muted fw-normal">ATTENDANCE</th><th class="text-end pe-5 text-muted fw-normal">ACTIONS</th></tr></thead>
                        <tbody>
                            {% for sub in subjects %}
                            <tr>
                                <td class="ps-5">
                                    <div class="fw-semibold text-dark fs-6">{{ sub.code }}</div>
                                    <a href="/subject/{{ sub.id }}" class="small text-decoration-none text-primary">{{ sub.name }} <i class="bi bi-arrow-right-short"></i></a>
                                    
                                    <div class="mt-2" style="width: 160px;">
                                        <div class="d-flex justify-content-between" style="font-size: 0.6rem; color: #94a3b8;"><span>YOU</span><span>{{ sub.student_progress_percent }}%</span></div>
                                        <div class="syllabus-mini"><span class="d-block h-100" style="width: {{ sub.student_progress_percent }}%; background: #10b981;"></span></div>
                                        
                                        <div class="d-flex justify-content-between mt-1" style="font-size: 0.6rem; color: #94a3b8;"><span>TEACHER</span><span>{{ sub.teacher_progress_percent }}%</span></div>
                                        <div class="syllabus-mini"><span class="d-block h-100" style="width: {{ sub.teacher_progress_percent }}%; background: #f59e0b;"></span></div>
                                    </div>
                                </td>
                                <td style="width: 35%;">
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <div class="fw-semibold {% if sub.attendance_percentage < 75 %}text-danger{% else %}text-success{% endif %}">{{ sub.attendance_percentage }}%</div>
                                        <span class="badge bg-light text-dark border fw-normal" style="font-size: 0.7rem;">{{ sub.bunk_status }}</span>
                                    </div>
                                    <div class="progress progress-slim"><div class="progress-bar {% if sub.attendance_percentage < 75 %}bg-danger{% else %}bg-success{% endif %}" style="width: {{ sub.attendance_percentage }}%"></div></div>
                                </td>
                                <td class="text-end pe-5">
                                    <div class="btn-group shadow-sm">
                                        <a href="/update_attendance/{{ sub.id }}/present" class="btn btn-sm btn-light border text-success"><i class="bi bi-check-lg"></i></a>
                                        <a href="/update_attendance/{{ sub.id }}/absent" class="btn btn-sm btn-light border text-danger"><i class="bi bi-x-lg"></i></a>
                                        <a href="/undo_attendance/{{ sub.id }}" class="btn btn-sm btn-light border text-muted" title="Undo"><i class="bi bi-arrow-counterclockwise"></i></a>
                                        <a href="/history/{{ sub.id }}" class="btn btn-sm btn-light border text-muted"><i class="bi bi-clock-history"></i></a>
                                    </div>
                                </td>
                            </tr>
                            {% else %}<tr><td colspan="3" class="text-center py-5 text-muted">No courses added yet.</td></tr>{% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="dashboard-card mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3"><h6 class="fw-semibold mb-0 text-muted">QUICK NOTES</h6></div>
                <form action="/add_note" method="POST" class="mb-3">
                    <div class="input-group"><input type="text" name="content" class="form-control" placeholder="Type & Enter..." required><button class="btn btn-sm btn-primary"><i class="bi bi-plus-lg"></i></button></div>
                </form>
                <div style="max-height: 200px; overflow-y: auto; padding-right: 5px;">
                    {% for note in notes %}
                    <div class="p-3 mb-2 rounded bg-white border shadow-sm position-relative">
                        <span style="font-size: 0.9rem; color: #475569;">{{ note.content }}</span>
                        <a href="/delete_note/{{ note.id }}" class="position-absolute top-0 end-0 p-2 text-danger opacity-50 hover-opacity-100"><i class="bi bi-x-circle-fill"></i></a>
                    </div>
                    {% else %}<div class="text-center text-muted small py-4">No notes.</div>{% endfor %}
                </div>
            </div>

            <div class="dashboard-card p-0 overflow-hidden">
                <div class="p-4 border-bottom d-flex justify-content-between align-items-center bg-light bg-opacity-30">
                    <h6 class="fw-semibold mb-0 text-dark">‚úÖ To-Do List</h6>
                    <button class="btn btn-sm btn-primary rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#taskModal">+ New Task</button>
                </div>
                <div class="list-group list-group-flush">
                    {% if assignments %}
                        {% for task in assignments %}
                        <div class="list-group-item border-bottom d-flex align-items-center justify-content-between py-3 px-4 position-relative" style="border-left: 0; border-right: 0;">
                            <div class="task-strip border-{{ task.color_tag or 'emerald' }}" style="width: 5px; height: 100%; position: absolute; left: 0; top: 0;"></div>
                            <div class="d-flex align-items-center gap-3 ps-2">
                                <a href="/mark_done/{{ task.id }}" class="btn btn-sm btn-outline-secondary rounded-circle p-0 d-flex align-items-center justify-content-center" style="width: 26px; height: 26px; border-color: #cbd5e1;"><i class="bi bi-check"></i></a>
                                <div>
                                    <div class="fw-semibold text-dark" style="font-size: 0.9rem;">{{ task.title }}</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">
                                        {{ task.subject.code }} ‚Ä¢ {{ task.due_date.strftime('%b %d') }}
                                        {% if task.estimated_hours and task.estimated_hours > 0 %}
                                            <span class="badge bg-secondary bg-opacity-10 text-secondary ms-1 fw-normal">{{ task.estimated_hours }}h</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% if task.is_exam %}<span class="badge bg-danger rounded-pill px-2 fw-normal">Exam</span>{% endif %}
                        </div>
                        {% endfor %}
                    {% else %}<div class="p-5 text-center text-muted small">No pending tasks. Great job! üéâ</div>{% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="profileModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-2"><div class="modal-header border-0 pb-0"><h5 class="modal-title fw-semibold">Settings</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form action="/update_profile" method="POST"><label class="small text-muted fw-bold mb-1">NAME</label><input type="text" name="student_name" class="form-control mb-3" value="{{ settings.student_name }}"><label class="small text-muted fw-bold mb-1">UNIVERSITY</label><input type="text" name="university" class="form-control mb-4" value="{{ settings.university }}"><button type="submit" class="btn btn-primary w-100 py-2">Save Changes</button></form></div></div></div></div>
<div class="modal fade" id="subjectModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-2"><div class="modal-header border-0 pb-0"><h5 class="modal-title fw-semibold">Add Course</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form action="/add_subject" method="POST"><input type="text" name="name" class="form-control mb-3" placeholder="Name" required><div class="row g-2 mb-3"><div class="col-6"><input type="text" name="code" class="form-control" placeholder="Code" required></div><div class="col-6"><input type="text" name="prof" class="form-control" placeholder="Prof"></div></div><label class="small text-muted fw-bold mb-2">SCHEDULE</label><div class="row g-2 mb-3"><div class="col-4"><select name="day" class="form-select bg-light border-0"><option value="MON">Mon</option><option value="TUE">Tue</option><option value="WED">Wed</option><option value="THU">Thu</option><option value="FRI">Fri</option></select></div><div class="col-4"><select name="start_time" class="form-select bg-light border-0"><option value="8">8 AM</option><option value="9">9 AM</option><option value="10">10 AM</option><option value="11">11 AM</option><option value="12">12 PM</option><option value="14">2 PM</option></select></div><div class="col-4"><select name="end_time" class="form-select bg-light border-0"><option value="9">9 AM</option><option value="10">10 AM</option><option value="11">11 AM</option><option value="12">12 PM</option><option value="13">1 PM</option><option value="15">3 PM</option></select></div></div><button type="submit" class="btn btn-primary w-100 py-2">Save Course</button></form></div></div></div></div>
<div class="modal fade" id="taskModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-2"><div class="modal-body p-4"><h5 class="fw-semibold mb-4">Create New Task</h5>{% if not subjects %}<div class="alert alert-warning small">Please add a course first!</div>{% else %}<form action="/add_assignment" method="POST"><select name="subject_id" class="form-select mb-3" required>{% for sub in subjects %}<option value="{{ sub.id }}">{{ sub.code }} - {{ sub.name }}</option>{% endfor %}</select><input type="text" name="title" class="form-control mb-3" placeholder="Task Title" required><div class="row g-2 mb-3"><div class="col-6"><input type="date" name="due_date" class="form-control" required></div><div class="col-6"><input type="number" step="0.5" name="hours" class="form-control" placeholder="Est. Hours"></div></div><label class="small text-muted fw-bold mb-2 d-block">COLOR TAG</label><div class="d-flex mb-4 gap-2 justify-content-start"><input type="radio" name="color_tag" value="emerald" id="c1" class="d-none" checked><label for="c1" class="color-option bg-emerald"></label><input type="radio" name="color_tag" value="blue" id="c2" class="d-none"><label for="c2" class="color-option bg-blue"></label><input type="radio" name="color_tag" value="purple" id="c3" class="d-none"><label for="c3" class="color-option bg-purple"></label><input type="radio" name="color_tag" value="amber" id="c4" class="d-none"><label for="c4" class="color-option bg-amber"></label><input type="radio" name="color_tag" value="rose" id="c5" class="d-none"><label for="c5" class="color-option bg-rose"></label><input type="radio" name="color_tag" value="slate" id="c6" class="d-none"><label for="c6" class="color-option bg-slate"></label></div><div class="form-check form-switch mb-4"><input class="form-check-input" type="checkbox" name="is_exam" id="isExam"><label class="form-check-label" for="isExam">This is an Exam</label></div><button type="submit" class="btn btn-primary w-100 py-2">Create Task</button></form>{% endif %}</div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('/static/sw.js'); }); }
    document.querySelectorAll('.color-option').forEach(el => { el.addEventListener('click', function() { document.querySelectorAll('.color-option').forEach(opt => opt.style.transform = 'scale(1)'); this.style.transform = 'scale(1.2)'; }); });
</script>
</body>
</html>